[[aerospike.repositories]]
= Aerospike repositories

[[aerospike-repo-intro]]
== Introduction

This chapter will point out the specialties for repository support for Aerospike. This builds on the core repository support explained in <<repositories>>. So make sure you've got a sound understanding of the basic concepts explained there.

[[aerospike-repo-usage]]
== Usage

To access domain entities stored in a Aerospike you can leverage our sophisticated repository support that eases implementing those quite significantly. To do so, simply create an interface for your repository:

.Sample Person entity
====
[source,java]
----
public class Person {

	@Id
	private String id;
	private String name;
	private int age;
	public Person(String id, String name, int age) {
		this.id = id;
		this.name = name;
		this.age = age;
	}
  // â€¦ getters and setters omitted
}
----
====
We have a quite simple domain object here. The default serialization mechanism used in `AerospikeTemplate` (which is backing the repository support) regards properties named id as document id. Currently we support`String` and `long` as id-types.

.Basic repository interface to persist Person entities
====
[source]
----
public interface PersonRepository extends AerospikeRepository<Person, String> {

	List<Person> findByName(String name);

	List<Person> findByNameStartsWith(String prefix);

}
----
====

Right now this interface simply serves typing purposes but we will add additional methods to it later. In your Spring configuration simply add

.General Aerospike repository Spring configuration
====
[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:aerospike="http://www.springframework.org/schema/data/aerospike"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/data/aerospike
    http://www.springframework.org/schema/data/aerospike/spring-aerospike-1.0.xsd">

  <aerospike:aerospike id="aerospike" />

  <bean id="aerospikeTemplate" class="rg.springframework.data.aerospike.core.AerospikeTemapate">
 </bean>

  <aerospike:repositories base-package="org.springframework.data.aerospike.example.data" />

</beans>
----
====

This namespace element will cause the base packages to be scanned for interfaces extending `AerospikeRepository` and create Spring beans for each of them found. By default the repositories will get a `AerospikeTemplate` Spring bean wired that is called `aerospikeTemplate`.

If you'd rather like to go with JavaConfig use the `@EnableAerospikeRepositories` annotation. The annotation carries the very same attributes like the namespace element. If no base package is configured the infrastructure will scan the package of the annotated configuration class.

.JavaConfig for repositories
====
[source,java]
----
@Configuration
@EnableAerospikeRepositories(basePackages = "org.springframework.data.aerospike.example")
public class TestRepositoryConfig {
	public @Bean(destroyMethod = "close") AerospikeClient aerospikeClient() {

		ClientPolicy policy = new ClientPolicy();
		policy.failIfNotConnected = true;

		return new AerospikeClient(policy, "52.23.205.208", 3000);
	}

	public @Bean AerospikeTemplate aerospikeTemplate() {
		return new AerospikeTemplate(aerospikeClient(), "test");
	}

}
----
====

As our domain repository extends `PagingAndSortingRepository` it provides you with CRUD operations as well as methods for paginated and sorted access to the entities. Working with the repository instance is just a matter of dependency injecting it into a client. So accessing the second page of `Person`s at a page size of 10 would simply look something like this:

.Paging access to Person entities
====
[source,java]
----
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration
public class PersonRepositoryTests {

    @Autowired PersonRepository repository;

    @Test
    public void readsFirstPageCorrectly() {

      Page<Person> persons = repository.findAll(new PageRequest(0, 10));
      assertThat(persons.isFirstPage(), is(true));
    }
}
----
====

The sample creates an application context with Spring's unit test support which will perform annotation based dependency injection into test cases. Inside the test method we simply use the repository to query the datastore. We hand the repository a `PageRequest` instance that requests the first page of persons at a page size of 10.

[[aerospiek.repositories.queries]]
== Query methods

Most of the data access operations you usually trigger on a repository result a query being executed against the Aerospike databases. Defining such a query is just a matter of declaring a method on the repository interface

.PersonRepository with query methods
====
[source,java]
----
public interface PersonRepository extends PagingAndSortingRepository<Person, String> {

    List<Person> findByName(String name);                              <1>

    Page<Person> findByName(String name, Pageable pageable);           <2>

    List<Person> findByNameStartsWith(String prefix);                  <3>
 
 }
----
<1> The method shows a query for all people with the given name. The query will be derived parsing the method name for constraints which can be concatenated with `And` and `Or`. 
<2> Applies pagination to a query. Just equip your method signature with a `Pageable` parameter and let the method return a `Page` instance and we will automatically page the query accordingly.
<3> Shows that you can query based partial name searches. 
====
[[aerospike.repositories.example]]

Here's a delete insert and query example
[source,java]
----
@ContextConfiguration(classes = TestRepositoryConfig.class)
public class RepositoryExample {

	@Autowired
	protected PersonRepository repository;
	@Autowired
	AerospikeOperations aerospikeOperations;
	@Autowired
	AerospikeClient client;
	/**
	 * @param ctx
	 */
	public RepositoryExample(ApplicationContext ctx) {
		aerospikeOperations = ctx.getBean(AerospikeTemplate.class);
		repository = (PersonRepository) ctx.getBean("personRepository");
		client = ctx.getBean(AerospikeClient.class);
	}
	/**
	 * @param args
	 */
	protected void setUp() {
		repository.deleteAll();
		Person dave = new Person("Dave-01", "Matthews", 42);
		Person donny = new Person("Dave-02", "Macintire", 39);
		Person oliver = new Person("Oliver-01", "Matthews", 4);
		Person carter = new Person("Carter-01", "Beauford", 49);
		Person boyd = new Person("Boyd-01", "Tinsley", 45);
		Person stefan = new Person("Stefan-01", "Lessard", 34);
		Person leroi = new Person("Leroi-01", "Moore", 41);
		Person leroi2 = new Person("Leroi-02", "Moore", 25);
		Person alicia = new Person("Alicia-01", "Keys", 30);
		repository.createIndex(Person.class, "person_name_index", "name",
				IndexType.STRING);
		List<Person> all = (List<Person>) repository.save(Arrays.asList(oliver,
				dave, donny, carter, boyd, stefan, leroi, leroi2, alicia));
	}

	/**
	 * @param args
	 */
	protected void cleanUp() {
		repository.deleteAll();
	}
	/**
	 * 
	 */
	protected void executeRepositoryCall() {
		List<Person> result = repository.findByName("Beauford");
		System.out.println("Results for exact match of 'Beauford'");
		for (Person person : result) {
			System.out.println(person.toString());
		}
		System.out.println("Results for name startting with letter 'M'");
		List<Person> resultPartial = repository.findByNameStartsWith("M");
		for (Person person : resultPartial) {
			System.out.println(person.toString());
		}
	}
	public static void main(String[] args) {

		ApplicationContext ctx = new AnnotationConfigApplicationContext(
				TestRepositoryConfig.class);
		RepositoryExample repositoryExample = new RepositoryExample(ctx);
		repositoryExample.setUp();
		repositoryExample.executeRepositoryCall();
		repositoryExample.cleanUp();
	}
}
----



